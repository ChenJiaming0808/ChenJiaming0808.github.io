# Cookie、Session、Token那点事儿
## 什么是Cookie？
Cookie 技术产生源于 HTTP 协议在互联网上的急速发展。随着互联网时代的策马奔腾，带宽等限制不存在了，人们需要更复杂的互联网社交活动，**就必须同服务器保持活动状态**。于是，在浏览器发展初期，为了适应用户的需求，技术上推出了各种保持 Web 浏览状态的手段，其中就包括了 Cookie 技术。Cookie 在计算机中是个储存在浏览器目录中的文件，当浏览器运行时，储存在 RAM 中发挥作用（此种 Cookies 称作 Session Cookies），一旦用户从该网站或服务器退出，Cookie 可储存在用户本地的硬盘上（此种 Cookies 称作 Persistent Cookies）。  
### Cookie 起源
1993年，网景公司雇员 Lou Montulli 为了让用户在访问某网站时，进一步提高访问速度，同时也为了进一步实现个人化网络，发明了今天广泛使用的 Cookie。  
### Cookie 时效性
目前有些 Cookie 是临时的，有些则是持续的。临时的 Cookie 只在浏览器上保存一段规定的时间，一旦超过规定的时间，该 Cookie 就会被系统清除。  
### Cookie 使用限制
Cookie 必须在 HTML 文件的内容输出之前设置；不同的浏览器对 Cookie 的处理规则不一致，使用时一定要考虑；客户端如果设置禁止 Cookie，则 Cookie 不能建立。并且在客户端，一个浏览器能创建的 Cookie 数量最多为300个，并且每个不能超过4KB，每个 Web 站点能设置的 Cookie 总数不能超过 20 个。
### 执行流程
1. 首先，客户端会发送一个 HTTP 请求到服务器端。
2. 服务器端接受客户端请求后，发送一个 HTTP 响应到客户端，这个响应头，其中就包含 Set-Cookie 头部。
3. 在客户端发起的第二次请求（注意：如果服务器需要我们带上 Cookie，我们就需要在上个步骤拿到这个 Cookie 然后作为请求头一起发起第二次请求），提供给了服务器端可以用来唯一标识客户端身份的信息。这时，服务器端也就可以判断客户端是否启用了 cookies。尽管，用户可能在和应用程序交互的过程中突然禁止 cookies 的使用，但是，这个情况基本是不太可能发生的，所以可以不加以考虑，这在实践中也被证明是对的。  
## Session
Session 是相对于服务端来说的，客户端是没有 Session 一说的。Session 是服务器在客户端建立连接时添加客户端连接标志，最终会在服务器软件（Apache、Tomcat、JBoss）转化为一个临时的 Cookie 发送给客户端，当客户端第一请求时服务器会检查是否携带了这个 Session（临时 Cookie），如果没有则会添加 Session，如果有就拿出这个 Session 来做相关操作。
## Token
token 是用户身份的验证方式，我们通常叫它：令牌。最简单的 token 组成:uid(用户唯一的身份标识)、time(当前时间的时间戳)、sign(签名，由 token 的前几位+盐以哈希算法压缩成一定长的十六进制字符串，可以防止恶意第三方拼接 token 请求服务器)。还可以把不变的参数也放进 token，避免多次查库。
### 应用场景
1. 当用户首次登录成功（注册也是一种可以适用的场景）之后, 服务器端就会生成一个 token 值，这个值，会在服务器保存 token 值(保存在数据库中)，再将这个 token 值返回给客户端
2. 客户端拿到 token 值之后,进行本地保存。（SP存储是大家能够比较支持和易于理解操作的存储）
3. 当客户端再次发送网络请求(一般不是登录请求)的时候,就会将这个 token 值附带到参数中发送给服务器
4. 服务器接收到客户端的请求之后,会取出 token 值与保存在本地(数据库)中的 token 值做对比
- 对比一：如果两个 token 值相同， 说明用户登录成功过!当前用户处于登录状态!
- 对比二：如果没有这个 token 值, 则说明没有登录成功。
- 对比三：如果 token 值不同: 说明原来的登录信息已经失效,让用户重新登录。
## Cookie和Session的区别
1. cookie 数据存放在客户的浏览器上，session 数据放在服务器上。
2. cookie 不是很安全，别人可以分析存放在本地的 cookie 并进行 cookie 欺骗,考虑到安全应当使用 session。
3. session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能,考虑到减轻服务器性能方面，应当使用 cookie。
4. 单个 cookie 保存的数据不能超过4K，很多浏览器都限制一个站点最多保存20个 cookie。
5. 所以个人建议：将登陆信息等重要信息存放为 session 其他信息如果需要保留，可以放在 cookie中。
## Token 和 Session 的区别
1. token 和 session 其实都是为了身份验证，session 一般翻译为会话，而 token 更多的时候是翻译为令牌。
2. session 服务器会保存一份，可能保存到缓存，文件，数据库；同样，session 和 token 都是有过期时间一说，都需要去管理过期时间。其实 token 与 session 的问题是一种时间与空间的博弈问题，session 是空间换时间，而 token 是时间换空间。两者的选择要看具体情况而定。
3. 虽然确实都是“客户端记录，每次访问携带”，但 token 很容易设计为自包含的，也就是说，后端不需要记录什么东西，每次一个无状态请求，每次解密验证，每次当场得出合法或非法的结论。这一切判断依据，除了固化在 CS 两端的一些逻辑之外，整个信息是自包含的。这才是真正的无状态。而 sessionid ，一般都是一段随机字符串，需要到后端去检索 id 的有效性。万一服务器重启导致内存里的 session 没了呢？万一 redis 服务器挂了呢？ 
### 解决方案
- 方案 A：我发给你一张身份证，但只是一张写着身份证号码的纸片。你每次来办事，我去后台查一下你的 id 是不是有效。 
- 方案 B：我发给你一张加密的身份证，以后你只要出示这张卡片，我就知道你一定是自己人。